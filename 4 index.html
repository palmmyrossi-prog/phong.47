<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมคำนวณเกรดสำหรับครู</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #f3e8ff 0%, #e0c3fc 40%, #a18cd1 80%, #fbc2eb 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        .bg-bubble {
            position: absolute;
            border-radius: 50%;
            filter: blur(18px);
            opacity: 0.45;
            z-index: 0;
        }
        .bubble1 { width: 320px; height: 320px; left: -80px; top: 40px; background: radial-gradient(circle, #a18cd1 60%, #fbc2eb 100%); }
        .bubble2 { width: 180px; height: 180px; right: -60px; top: 120px; background: radial-gradient(circle, #fbc2eb 60%, #a18cd1 100%); }
        .bubble3 { width: 220px; height: 220px; left: 40vw; bottom: -100px; background: radial-gradient(circle, #7c3aed 60%, #f3e8ff 100%); }
        .table-cell-custom {
            white-space: nowrap;
        }
        /* เพิ่มสีสันให้ input, select, ตาราง, hover */
        input[type="text"], input[type="number"] {
            background: linear-gradient(90deg, #f3e8ff 60%, #fbc2eb 100%);
            border: 2px solid #a18cd1;
            color: #7c3aed;
            font-weight: 500;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: #f472b6;
            box-shadow: 0 0 0 2px #fbc2eb55;
        }
        table.w-full {
            background: linear-gradient(90deg, #f3e8ff 60%, #fbc2eb 100%);
            border-radius: 1.2rem;
            overflow: hidden;
            box-shadow: 0 4px 24px 0 #a18cd133;
        }
        thead.bg-gray-200 {
            background: linear-gradient(90deg, #a18cd1 60%, #fbc2eb 100%) !important;
        }
        th, td {
            border-bottom: 1.5px solid #e0c3fc !important;
        }
        tr:hover {
            background: linear-gradient(90deg, #fbc2eb 60%, #a18cd1 100%) !important;
            color: #7c3aed !important;
            transition: background 0.2s, color 0.2s;
        }
        th {
            color: #7c3aed !important;
            font-weight: 700;
            font-size: 1.05rem;
        }
        td {
            color: #6d28d9 !important;
            font-weight: 500;
        }
        /* เพิ่มเงาและขอบมนให้ section */
        .bg-gray-50, .bg-white {
            background: linear-gradient(120deg, #f3e8ff 60%, #fbc2eb 100%) !important;
            border-radius: 1.2rem !important;
            box-shadow: 0 4px 24px 0 #a18cd133 !important;
        }
        /* เพิ่ม animation ให้หัวข้อ */
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradientMove 3s ease-in-out infinite;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* ปุ่มสดใส */
        button, .bg-green-500, .bg-blue-600, .bg-red-600 {
            box-shadow: 0 2px 8px #a18cd133;
            transition: background 0.2s, transform 0.2s;
        }
        button:hover, .bg-green-500:hover, .bg-blue-600:hover, .bg-red-600:hover {
            filter: brightness(1.08) saturate(1.2);
            transform: scale(1.04);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-bubble bubble1"></div>
    <div class="bg-bubble bubble2"></div>
    <div class="bg-bubble bubble3"></div>

    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-10 w-full max-w-6xl">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">ระบบคำนวณเกรด</h1>
    <h1 class="text-3xl md:text-4xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-400 to-yellow-400 mb-6 animate-gradient drop-shadow-lg tracking-wider">ระบบคำนวณเกรด</h1>
        <p class="text-center text-gray-500 mb-8">สำหรับครูผู้สอนเพื่อคำนวณเกรดของนักเรียน</p>

        <!-- Grade Weight Settings Section -->
        <div class="bg-gray-50 p-6 rounded-lg mb-8 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">ตั้งค่าน้ำหนักคะแนน</h2>
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
                <div class="flex-1">
                    <label for="work-weight" class="block text-gray-600 mb-1">น้ำหนักคะแนนเก็บ (Work Score)</label>
                    <input type="number" id="work-weight" value="0.6" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="flex-1">
                    <label for="exam-weight" class="block text-gray-600 mb-1">น้ำหนักคะแนนสอบ (Exam Score)</label>
                    <input type="number" id="exam-weight" value="0.4" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
            </div>
            <p id="weight-error" class="text-red-500 text-sm mt-2 hidden">น้ำหนักคะแนนรวมต้องเท่ากับ 1.0!</p>
        </div>

        <!-- Add Student Form Section -->
        <div class="bg-white p-6 rounded-lg mb-8 shadow-sm border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">เพิ่มรายชื่อนักเรียน</h2>
            <form id="add-student-form" class="space-y-4">
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                    <input type="text" id="student-name" placeholder="ชื่อ-นามสกุล" required class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                    <input type="number" id="student-work-score" placeholder="คะแนนเก็บ (0-100)" min="0" max="100" required class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                    <input type="number" id="student-exam-score" placeholder="คะแนนสอบ (0-100)" min="0" max="100" required class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                </div>
                <div class="flex justify-center">
                    <button type="submit" class="w-full md:w-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 shadow-lg">
                        เพิ่มนักเรียน
                    </button>
                </div>
            </form>
        </div>

        <!-- Control Buttons Section -->
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
            <button id="calculate-all-btn" class="w-full md:flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 shadow-lg">
                คำนวณเกรดทั้งหมด
            </button>
            <button id="clear-all-btn" class="w-full md:flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300 shadow-lg">
                ลบข้อมูลทั้งหมด
            </button>
        </div>

        <!-- Results Table Section -->
        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                    <tr>
                        <th scope="col" class="px-6 py-3">#</th>
                        <th scope="col" class="px-6 py-3">ชื่อ</th>
                        <th scope="col" class="px-6 py-3 table-cell-custom">คะแนนเก็บ</th>
                        <th scope="col" class="px-6 py-3 table-cell-custom">คะแนนสอบ</th>
                        <th scope="col" class="px-6 py-3 table-cell-custom">คะแนนรวม</th>
                        <th scope="col" class="px-6 py-3">เกรด</th>
                        <th scope="col" class="px-6 py-3">
                            <span class="sr-only">ลบ</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Student data will be inserted here by JavaScript -->
                    <tr id="loading-row"><td colspan="7" class="text-center py-4 text-gray-500">กำลังโหลดข้อมูล...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Custom Message Modal -->
        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-transform duration-300 scale-95">
                <p id="modal-message" class="text-lg font-semibold text-gray-700 mb-4"></p>
                <button id="modal-close-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">ตกลง</button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript section
        
        // DOM element references
        const addStudentForm = document.getElementById('add-student-form');
        const studentNameInput = document.getElementById('student-name');
        const studentWorkScoreInput = document.getElementById('student-work-score');
        const studentExamScoreInput = document.getElementById('student-exam-score');
        const resultsTableBody = document.getElementById('results-table-body');
        const calculateAllBtn = document.getElementById('calculate-all-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const workWeightInput = document.getElementById('work-weight');
        const examWeightInput = document.getElementById('exam-weight');
        const weightError = document.getElementById('weight-error');
        const loadingRow = document.getElementById('loading-row');

        // Modal elements
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Function to show the custom message modal
        function showMessage(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // Function to hide the custom message modal
        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });
        messageModal.addEventListener('click', (e) => {
            if (e.target === messageModal) {
                messageModal.classList.add('hidden');
            }
        });

        // The URL for the Google Sheets published as CSV
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuiRQzgkHDpYOjBfmDaf7KFyomYazkjCtmSjM-3pDGS0wIReRnlCfGkv_3j-6m4z2B0g78eFYC5YI2/pub?gid=948998057&single=true&output=csv';

        let students = [];

        // Function to fetch and parse data from Google Sheets
        async function fetchAndParseData() {
            loadingRow.classList.remove('hidden');
            try {
                const response = await fetch(GOOGLE_SHEETS_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const csvText = await response.text();
                students = parseCsvData(csvText);
                saveStudents(); // Save fetched data to localStorage
                renderStudents();
            } catch (error) {
                console.error('Error fetching or parsing data:', error);
                showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูลจาก Google Sheets');
                // Fallback to localStorage if fetching fails
                students = JSON.parse(localStorage.getItem('students')) || [];
                renderStudents();
            } finally {
                loadingRow.classList.add('hidden');
            }
        }

        // Function to parse the CSV text and convert it to a student array
        function parseCsvData(csv) {
            const studentsArray = [];
            const rows = csv.split('\n');
            
            // Skip the first 4 header rows and the subject header row
            // The actual data starts from row 6 (index 5)
            for (let i = 5; i < rows.length; i++) {
                const row = rows[i].trim();
                if (row.length === 0) continue; // Skip empty rows

                const cols = row.split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                
                // Extract name and scores for 'ภาษาไทย' subject
                // Name is at index 1, Work Score is at index 2, Exam Score is at index 3
                const name = cols[1];
                const workScore = parseFloat(cols[2]);
                const examScore = parseFloat(cols[3]);

                // Basic validation for name and scores
                if (name && !isNaN(workScore) && !isNaN(examScore)) {
                    studentsArray.push({
                        name: name,
                        workScore: workScore,
                        examScore: examScore
                    });
                }
            }
            return studentsArray;
        }

        // Function to save students array to localStorage
        function saveStudents() {
            localStorage.setItem('students', JSON.stringify(students));
        }

        // Function to calculate grade based on total score
        function calculateGrade(totalScore) {
            if (totalScore >= 80) return 'A';
            if (totalScore >= 70) return 'B';
            if (totalScore >= 60) return 'C';
            if (totalScore >= 50) return 'D';
            return 'F';
        }
        
        // Function to render student data to the table
        function renderStudents() {
            resultsTableBody.innerHTML = ''; // Clear table
            const workWeight = parseFloat(workWeightInput.value);
            const examWeight = parseFloat(examWeightInput.value);

            students.forEach((student, index) => {
                // Calculate total score using the defined weights
                const totalScore = (student.workScore * workWeight) + (student.examScore * examWeight);
                const grade = calculateGrade(totalScore);

                // Create a new table row element
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-gray-50 transition-colors duration-200 ${index % 2 === 0 ? '' : 'bg-gray-50'}`;

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4">${student.name}</td>
                    <td class="px-6 py-4 text-center">${student.workScore}</td>
                    <td class="px-6 py-4 text-center">${student.examScore}</td>
                    <td class="px-6 py-4 text-center font-bold">${totalScore.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center text-lg font-extrabold ${grade === 'A' ? 'text-green-600' : grade === 'B' ? 'text-blue-600' : grade === 'C' ? 'text-yellow-600' : grade === 'D' ? 'text-orange-600' : 'text-red-600'}">${grade}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="delete-btn font-medium text-red-600 hover:text-red-800 transition-colors duration-200" data-index="${index}">ลบ</button>
                    </td>
                `;
                resultsTableBody.appendChild(row);
            });
        }

        // Event listener for the "Add Student" form submission
        addStudentForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Prevent page reload

            // Get values from input fields and trim whitespace
            const name = studentNameInput.value.trim();
            const workScore = parseFloat(studentWorkScoreInput.value);
            const examScore = parseFloat(studentExamScoreInput.value);

            // Validate inputs
            if (!name || isNaN(workScore) || isNaN(examScore)) {
                showMessage('กรุณาป้อนข้อมูลให้ครบถ้วนและถูกต้อง');
                return;
            }

            // Create a new student object
            const newStudent = {
                name: name,
                workScore: workScore,
                examScore: examScore
            };

            // Add new student to the array
            students.push(newStudent);
            saveStudents(); // Save to localStorage

            // Reset form inputs
            addStudentForm.reset();

            // Re-render the table
            renderStudents();
        });

        // Event listener for the "Calculate All Grades" button
        calculateAllBtn.addEventListener('click', () => {
            const workWeight = parseFloat(workWeightInput.value);
            const examWeight = parseFloat(examWeightInput.value);
            
            // Validate the sum of weights
            if ((workWeight + examWeight).toFixed(2) !== '1.00') {
                weightError.classList.remove('hidden');
                showMessage('น้ำหนักคะแนนรวมต้องเท่ากับ 1.0! กรุณาตรวจสอบและแก้ไข');
            } else {
                weightError.classList.add('hidden');
                renderStudents(); // Re-render with new weights
                showMessage('คำนวณเกรดทั้งหมดเรียบร้อยแล้ว!');
            }
        });

        // Event listeners for weight input changes to hide the error message
        workWeightInput.addEventListener('input', () => {
            weightError.classList.add('hidden');
        });
        examWeightInput.addEventListener('input', () => {
            weightError.classList.add('hidden');
        });

        // Event listener for "Clear All" button
        clearAllBtn.addEventListener('click', () => {
            students = []; // Clear the array
            saveStudents(); // Save the empty array to localStorage
            renderStudents(); // Render the empty table
            showMessage('ลบข้อมูลทั้งหมดเรียบร้อยแล้ว');
        });

        // Event listener for "Delete" buttons
        resultsTableBody.addEventListener('click', (e) => {
            // Check if the clicked element is a delete button
            if (e.target.classList.contains('delete-btn')) {
                const index = e.target.getAttribute('data-index');
                students.splice(index, 1); // Remove the student from the array
                saveStudents(); // Save the updated array
                renderStudents(); // Re-render the table
                showMessage('ลบนักเรียนเรียบร้อยแล้ว');
            }
        });

        // Initial render on page load
        fetchAndParseData();
    </script>

</body>
</html>
